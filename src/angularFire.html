<!DOCTYPE html>

<html>
<head>
  <title>angularfire.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>angularfire.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>AngularFire is an officially supported AngularJS binding for Firebase.
The bindings let you associate a Firebase URL with a model (or set of
models), and they will be transparently kept in sync across all clients
currently using your app. The 2-way data binding offered by AngularJS works
as normal, except that the changes are also sent to all other clients
instead of just a server.</p>
<pre><code> AngularFire 0.3
 http://angularfire.com
 License: MIT</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Define the <code>firebase</code> module under which all AngularFire services will live.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>angular.module(<span class="string">"firebase"</span>, []).value(<span class="string">"Firebase"</span>, Firebase);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Define the <code>angularFire</code> service for implicit syncing. <code>angularFire</code> binds a
model to $scope and keeps the data synchronized with a Firebase location
both ways.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>angular.module(<span class="string">"firebase"</span>).factory(<span class="string">"angularFire"</span>, [<span class="string">"$q"</span>, <span class="string">"$parse"</span>, <span class="string">"$timeout"</span>,
  <span class="keyword">function</span>($q, $parse, $timeout) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The factory returns a new instance of the <code>AngularFire</code> object, defined
below, everytime it is called. The factory takes 3 arguments:</p>
<ul>
<li><code>ref</code>:    A Firebase reference. Queries or limits may be applied.</li>
<li><code>$scope</code>: The scope with which the bound model is associated.</li>
<li><code>name</code>:   The name of the model.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="keyword">function</span>(ref, scope, name) {
      <span class="keyword">var</span> af = <span class="keyword">new</span> AngularFire($q, $parse, $timeout, ref);
      <span class="keyword">return</span> af.associate(scope, name);
    };
  }
]);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The <code>AngularFire</code> object that implements implicit synchronization.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">AngularFire</span><span class="params">($q, $parse, $timeout, ref)</span> {</span>
  <span class="keyword">this</span>._q = $q;
  <span class="keyword">this</span>._parse = $parse;
  <span class="keyword">this</span>._timeout = $timeout;
  <span class="keyword">this</span>._initial = <span class="literal">true</span>;
  <span class="keyword">this</span>._remoteValue = <span class="literal">false</span>;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> ref == <span class="string">"string"</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Please provide a Firebase reference instead "</span> +
      <span class="string">"of a URL, eg: new Firebase(url)"</span>);
  }
  <span class="keyword">this</span>._fRef = ref;
}
AngularFire.prototype = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This function is called by the factory to create a new 2-way binding
between a particular model in a <code>$scope</code> and a particular Firebase
location.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  associate: <span class="keyword">function</span>($scope, name) {
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    <span class="keyword">var</span> deferred = <span class="keyword">this</span>._q.defer();
    <span class="keyword">var</span> promise = deferred.promise;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>We&#39;re currently listening for value changes to implement synchronization.
This needs to be optimized, see
<a href="https://github.com/firebase/angularFire/issues/25">Ticket #25</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>._fRef.on(<span class="string">"value"</span>, <span class="keyword">function</span>(snap) {
      <span class="keyword">var</span> remote = snap.val();</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>We use toJson/fromJson to remove $$hashKey. Can be replaced by
angular.copy, but only for later version of AngularJS.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> local = angular.fromJson(angular.toJson(self._parse(name)($scope)));

      <span class="keyword">if</span> (self._initial) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>First value received from the server. We try and merge any local
changes that may have been made with the server values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self._initial = <span class="literal">false</span>;
        <span class="keyword">var</span> merged = <span class="literal">false</span>;
        <span class="keyword">var</span> check = Object.prototype.toString;
        <span class="keyword">if</span> (remote &amp;&amp; check.call(local) == check.call(remote)) {
          <span class="keyword">if</span> (check.call(local) == <span class="string">"[object Array]"</span>) {
            merged = local.concat(remote);
            <span class="keyword">if</span> (!angular.equals(merged, remote)) {
              self._fRef.ref().set(merged);
              remote = merged;
            }
          } <span class="keyword">else</span> <span class="keyword">if</span> (check.call(local) == <span class="string">"[object Object]"</span>) {
            merged = local;
            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> remote) {
              merged[key] = remote[key];
            }
            self._fRef.ref().update(merged);
            remote = merged;
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If remote value is null, overwrite remote value with local</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (remote === <span class="literal">null</span>) {
          self._fRef.ref().set(local);
          remote = local;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If types don&#39;t match or the type is primitive, just overwrite the
local value with the remote value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      }

      <span class="keyword">var</span> resolve = <span class="literal">false</span>;
      <span class="keyword">if</span> (deferred) {
        resolve = deferred;
        deferred = <span class="literal">false</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Update the local model to reflect remote changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self._timeout(<span class="keyword">function</span>() {
        self._resolve($scope, name, resolve, remote)
      });
    });
    <span class="keyword">return</span> promise;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Disassociation added via
<a href="https://github.com/firebase/angularFire/pull/34">pull request #34</a>.
This function is provided to the promise returned by <code>angularFire</code>
when it is fulfilled. Invoking it will stop the two-way synchronization.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  disassociate: <span class="keyword">function</span>() {
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    <span class="keyword">if</span> (self._unregister) {
      self._unregister();
    }
    <span class="keyword">this</span>._fRef.off(<span class="string">"value"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>If <code>deferred</code> is a valid promise, it will be resolved with <code>val</code>, and
the model will be watched for future (local) changes. <code>$scope[name]</code>
will also be updated to the provided value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _resolve: <span class="keyword">function</span>($scope, name, deferred, val) {
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    <span class="keyword">if</span> (val === <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>NULL values are special in Firebase. If received, set the local value
to the initial state for Objects and Arrays.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> localVal = $scope[name];
      <span class="keyword">if</span> (<span class="keyword">typeof</span> localVal == <span class="string">"object"</span>) {
        <span class="keyword">var</span> check = Object.prototype.toString;
        <span class="keyword">if</span> (check.call(localVal) == check.call([])) {
          val = [];
        } <span class="keyword">else</span> {
          val = {};
        }
      }
    }
    <span class="keyword">this</span>._remoteValue = angular.copy(val);
    <span class="keyword">this</span>._parse(name).assign($scope, angular.copy(val));
    <span class="keyword">if</span> (deferred) {
      deferred.resolve(<span class="keyword">function</span>() {
        self.disassociate();
      });
      <span class="keyword">this</span>._watch($scope, name);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Watch for local changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _watch: <span class="keyword">function</span>($scope, name) {
    <span class="keyword">var</span> self = <span class="keyword">this</span>;
    self._unregister = $scope.$watch(name, <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>We ignore local value changes until the first value was received
from the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (self._initial) {
        <span class="keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>If the new local value matches the current remote value, we don&#39;t
trigger a remote update.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> val = angular.fromJson(angular.toJson(self._parse(name)($scope)));
      <span class="keyword">if</span> (angular.equals(val, self._remoteValue)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> check = Object.prototype.toString;
      <span class="keyword">if</span> (check.call(val) == <span class="string">"[object Object]"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Use update if limits are in effect, set if not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (self._fRef.set) {
          self._fRef.set(val);
        } <span class="keyword">else</span> {
          self._fRef.ref().update(val);
        }
      } <span class="keyword">else</span> {
        self._fRef.ref().set(val);
      }
    }, <span class="literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Also watch for scope destruction and unregister.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $scope.$on(<span class="string">"$destroy"</span>, <span class="keyword">function</span>() {
      self.disassociate();
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Helper function to log messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _log: <span class="keyword">function</span>(msg) {
    <span class="keyword">if</span> (console &amp;&amp; console.log) {
      console.log(msg);
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Define the <code>angularFireCollection</code> service for explicit syncing.
<code>angularFireCollection</code> provides a collection object that you can modify.
<a href="https://github.com/petebacondarwin/angular-firebase/blob/master/ng-firebase-collection.js">Original code</a>
by @petebacondarwin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>angular.module(<span class="string">"firebase"</span>).factory(<span class="string">"angularFireCollection"</span>, [<span class="string">"$timeout"</span>,
  <span class="keyword">function</span>($timeout) {
    <span class="keyword">return</span> <span class="keyword">function</span>(collectionRef, initialCb) {
      <span class="keyword">if</span> (<span class="keyword">typeof</span> collectionRef == <span class="string">"string"</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Please provide a Firebase reference instead "</span> +
          <span class="string">"of a URL, eg: new Firebase(url)"</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>An internal representation of a model present in the collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="keyword">function</span> <span class="title">angularFireItem</span><span class="params">(ref, index)</span> {</span>
        <span class="keyword">this</span>.$ref = ref.ref();
        <span class="keyword">this</span>.$id = ref.name();
        <span class="keyword">this</span>.$index = index;
        angular.extend(<span class="keyword">this</span>, {$priority: ref.getPriority()}, ref.val());
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Implementation of firebase priority ordering:
<a href="https://www.firebase.com/docs/javascript/firebase/setpriority.html">https://www.firebase.com/docs/javascript/firebase/setpriority.html</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> firebaseOrder = [</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Partition into [ no priority, number as priority, string as priority ]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">function</span>(item) {
          <span class="keyword">if</span> (item.$priority == <span class="literal">null</span>) {
            <span class="keyword">return</span> <span class="number">0</span>;
          } <span class="keyword">else</span> <span class="keyword">if</span> (angular.isNumber(item.$priority)) {
            <span class="keyword">return</span> <span class="number">1</span>;
          } <span class="keyword">else</span> <span class="keyword">if</span> (angular.isString(item.$priority)) {
            <span class="keyword">return</span> <span class="number">2</span>;
          }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Within partions, sort first by priority (lexical or numerical,
no priority skips this level of sorting by returning Infinity)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">function</span>(item) {
          <span class="keyword">return</span> item.$priority ? item.$priority : <span class="literal">Infinity</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Finally, sort items of equal priority lexically by name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">function</span>(item) {
          <span class="keyword">return</span> item.$id;
        }
      ];

      <span class="keyword">var</span> indexes = {};
      <span class="keyword">var</span> collection = [];

      <span class="function"><span class="keyword">function</span> <span class="title">getIndex</span><span class="params">(prevId)</span> {</span>
        <span class="keyword">return</span> prevId ? indexes[prevId] + <span class="number">1</span> : <span class="number">0</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Add an item to the local collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="keyword">function</span> <span class="title">addChild</span><span class="params">(index, item)</span> {</span>
        indexes[item.$id] = index;
        collection.splice(index, <span class="number">0</span>, item);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Remove an item from the local collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="keyword">function</span> <span class="title">removeChild</span><span class="params">(id)</span> {</span>
        <span class="keyword">var</span> index = indexes[id];
        collection.splice(index, <span class="number">1</span>);
        indexes[id] = <span class="literal">undefined</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Update an existing child in the local collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="keyword">function</span> <span class="title">updateChild</span><span class="params">(index, item)</span> {</span>
        collection[index] = item;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Move an existing child to a new location in the collection (usually
triggered by a priority change).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="keyword">function</span> <span class="title">moveChild</span><span class="params">(from, to, item)</span> {</span>
        collection.splice(from, <span class="number">1</span>);
        collection.splice(to, <span class="number">0</span>, item);
        updateIndexes(from, to);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Update the index table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="keyword">function</span> <span class="title">updateIndexes</span><span class="params">(from, to)</span> {</span>
        <span class="keyword">var</span> length = collection.length;
        to = to || length;
        <span class="keyword">if</span> (to &gt; length) {
          to = length;
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> index = from; index &lt; to; index++) {
          <span class="keyword">var</span> item = collection[index];
          item.$index = indexes[item.$id] = index;
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Trigger the initial callback, if one was provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (initialCb &amp;&amp; <span class="keyword">typeof</span> initialCb == <span class="string">"function"</span>) {
        collectionRef.once(<span class="string">"value"</span>, initialCb);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Attach handlers for remote child added, removed, changed and moved
events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collectionRef.on(<span class="string">"child_added"</span>, <span class="keyword">function</span>(data, prevId) {
        $timeout(<span class="keyword">function</span>() {
          <span class="keyword">var</span> index = getIndex(prevId);
          addChild(index, <span class="keyword">new</span> angularFireItem(data, index));
          updateIndexes(index);
        });
      });

      collectionRef.on(<span class="string">"child_removed"</span>, <span class="keyword">function</span>(data) {
        $timeout(<span class="keyword">function</span>() {
          <span class="keyword">var</span> id = data.name();
          <span class="keyword">var</span> pos = indexes[id];
          removeChild(id);
          updateIndexes(pos);
        });
      });

      collectionRef.on(<span class="string">"child_changed"</span>, <span class="keyword">function</span>(data, prevId) {
        $timeout(<span class="keyword">function</span>() {
          <span class="keyword">var</span> index = indexes[data.name()];
          <span class="keyword">var</span> newIndex = getIndex(prevId);
          <span class="keyword">var</span> item = <span class="keyword">new</span> angularFireItem(data, index);

          updateChild(index, item);
          <span class="keyword">if</span> (newIndex !== index) {
            moveChild(index, newIndex, item);
          }
        });
      });

      collectionRef.on(<span class="string">"child_moved"</span>, <span class="keyword">function</span>(ref, prevId) {
        $timeout(<span class="keyword">function</span>() {
          <span class="keyword">var</span> oldIndex = indexes[ref.name()];
          <span class="keyword">var</span> newIndex = getIndex(prevId);
          <span class="keyword">var</span> item = collection[oldIndex];
          moveChild(oldIndex, newIndex, item);
        });
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><code>angularFireCollection</code> exposes four methods on the collection
returned.</p>
<p>Retrieve object by name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.getByName = <span class="keyword">function</span>(name) {
        <span class="keyword">return</span> collection[indexes[name]];
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Add an object to the remote collection. Adding an object is the
equivalent of calling <code>push()</code> on a Firebase reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.add = <span class="keyword">function</span>(item, cb) {
        <span class="keyword">var</span> ref;
        <span class="keyword">if</span> (!cb) {
          ref = collectionRef.ref().push(item);
        } <span class="keyword">else</span> {
          ref = collectionRef.ref().push(item, cb);
        }
        <span class="keyword">return</span> ref;
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Remove an object from the remote collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.remove = <span class="keyword">function</span>(itemOrId, cb) {
        <span class="keyword">var</span> item = angular.isString(itemOrId) ?
          collection[indexes[itemOrId]] : itemOrId;
        <span class="keyword">if</span> (!cb) {
          item.$ref.remove();
        } <span class="keyword">else</span> {
          item.$ref.remove(cb);
        }
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Update an object in the remote collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.update = <span class="keyword">function</span>(itemOrId, cb) {
        <span class="keyword">var</span> item = angular.isString(itemOrId) ?
          collection[indexes[itemOrId]] : itemOrId;
        <span class="keyword">var</span> copy = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Update all properties, unless they&#39;re ones created by Angular.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        angular.forEach(item, <span class="keyword">function</span>(value, key) {
          <span class="keyword">if</span> (key.indexOf(<span class="string">"$"</span>) !== <span class="number">0</span>) {
            copy[key] = value;
          }
        });
        <span class="keyword">if</span> (!cb) {
          item.$ref.set(copy);
        } <span class="keyword">else</span> {
          item.$ref.set(copy, cb);
        }
      };

      collection.order = firebaseOrder;
      <span class="keyword">return</span> collection;
    }
  }
]);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Defines the <code>angularFireAuth</code> service that provides authentication support
for AngularFire.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>angular.module(<span class="string">"firebase"</span>).factory(<span class="string">"angularFireAuth"</span>, [
   <span class="string">"$rootScope"</span>, <span class="string">"$parse"</span>, <span class="string">"$timeout"</span>, <span class="string">"$location"</span>, <span class="string">"$route"</span>, <span class="string">"$q"</span>,
   <span class="keyword">function</span>($rootScope, $parse, $timeout, $location, $route, $q) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Helper function to extract claims from a JWT. Does <em>not</em> verify the
validity of the token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">deconstructJWT</span><span class="params">(token)</span> {</span>
      <span class="keyword">var</span> segments = token.split(<span class="string">"."</span>);
      <span class="keyword">if</span> (!segments <span class="keyword">instanceof</span> Array || segments.length !== <span class="number">3</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Invalid JWT"</span>);
      }
      <span class="keyword">var</span> claims = segments[<span class="number">1</span>];
      <span class="keyword">if</span> (window.atob) {
        <span class="keyword">return</span> JSON.parse(decodeURIComponent(escape(window.atob(claims))));
      }
      <span class="keyword">return</span> token;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Updates the provided model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">updateExpression</span><span class="params">(scope, name, val, cb)</span> {</span>
      <span class="keyword">if</span> (name) {
        $timeout(<span class="keyword">function</span>() {
          $parse(name).assign(scope, val);
          cb();
        });
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>A function to check whether the current path requires authentication,
and if so, whether a redirect to a login page is needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">authRequiredRedirect</span><span class="params">(route, path, self)</span> {</span>
      <span class="keyword">if</span> (route.authRequired &amp;&amp; !self._authenticated){
        <span class="keyword">if</span> (route.pathTo === <span class="literal">undefined</span>) {
          self._redirectTo = $location.path();
        } <span class="keyword">else</span> {
          self._redirectTo = route.pathTo === path ? <span class="string">"/"</span> : route.pathTo;
        }
        $location.replace();
        $location.path(path);
      }
    }

    <span class="keyword">return</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Initializes the authentication service. Takes a Firebase reference and
an options object, that may contain the following properties:</p>
<ul>
<li><code>scope</code>: The scope to which user authentication status will be
bound to. Defaults to <code>$rootScope</code> if not provided.</li>
<li><code>name</code>: Name of the model to which user auth state is bound.</li>
<li><code>callback</code>: A function that will be called when there is a change
in authentication state.</li>
<li><code>path</code>: The path to which the user will be redirected if the
<code>authRequired</code> property was set to true in the <code>$routeProvider</code>, and
the user isn&#39;t logged in.</li>
<li><code>simple</code>: AngularFireAuth requires inclusion of the
<code>firebase-simple-login.js</code> file by default. If this value is set to
false, this requirement is waived, but only custom login functionality
will be enabled.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      initialize: <span class="keyword">function</span>(ref, options) {
        <span class="keyword">var</span> self = <span class="keyword">this</span>;

        <span class="keyword">if</span> (<span class="keyword">typeof</span> ref == <span class="string">"string"</span>) {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Please provide a Firebase reference instead "</span> +
            <span class="string">"of a URL, eg: new Firebase(url)"</span>);
        }

        options = options || {};
        <span class="keyword">this</span>._scope = $rootScope;
        <span class="keyword">if</span> (options.scope) {
          <span class="keyword">this</span>._scope = options.scope;
        } <span class="keyword">else</span> {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Scope not provided to angularFireAuth!"</span>);
        }
        <span class="keyword">if</span> (options.name) {
          <span class="keyword">this</span>._name = options.name;
        } <span class="keyword">else</span> {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Model name not provided to angularFireAuth!"</span>);
        }

        <span class="keyword">this</span>._cb = <span class="keyword">function</span>(){};
        <span class="keyword">if</span> (options.callback &amp;&amp; <span class="keyword">typeof</span> options.callback === <span class="string">"function"</span>) {
          <span class="keyword">this</span>._cb = options.callback;
        }

        <span class="keyword">this</span>._redirectTo = <span class="literal">null</span>;
        <span class="keyword">this</span>._authenticated = <span class="literal">false</span>;
        <span class="keyword">if</span> (options.path) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Check if the current page requires authentication.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> ($route.current) {
            authRequiredRedirect($route.current, options.path, self);
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Set up a handler for all future route changes, so we can check
if authentication is required.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          $rootScope.$on(<span class="string">"$routeChangeStart"</span>, <span class="keyword">function</span>(e, next) {
            authRequiredRedirect(next, options.path, self);
          });
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Initialize user authentication state to <code>null</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>._ref = ref;
        <span class="keyword">if</span> (options.simple === <span class="literal">false</span>) {
          updateExpression(<span class="keyword">this</span>._scope, <span class="keyword">this</span>._name, <span class="literal">null</span>, <span class="keyword">function</span>() {});
          <span class="keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Initialize Simple Login.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!window.FirebaseSimpleLogin) {
          <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">"FirebaseSimpleLogin undefined, "</span> +
            <span class="string">"did you include firebase-simple-login.js?"</span>);
          $rootScope.$broadcast(<span class="string">"angularFireAuth:error"</span>, err);
          <span class="keyword">return</span>;
        }
        <span class="keyword">var</span> client = <span class="keyword">new</span> FirebaseSimpleLogin(<span class="keyword">this</span>._ref, <span class="keyword">function</span>(err, user) {
          self._cb(err, user);
          <span class="keyword">if</span> (err) {
            $rootScope.$broadcast(<span class="string">"angularFireAuth:error"</span>, err);
          } <span class="keyword">else</span> <span class="keyword">if</span> (user) {
            self._loggedIn(user)
          } <span class="keyword">else</span> {
            self._loggedOut();
          }
        });
        <span class="keyword">this</span>._authClient = client;
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>The login method takes a provider (for Simple Login) or a token
(for Custom Login) and authenticates the Firebase URL with which
the service was initialized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      login: <span class="keyword">function</span>(tokenOrProvider, options) {
        <span class="keyword">var</span> promise = <span class="keyword">this</span>._watchForLogin();
        <span class="keyword">switch</span> (tokenOrProvider) {
        <span class="keyword">case</span> <span class="string">"github"</span>:
        <span class="keyword">case</span> <span class="string">"persona"</span>:
        <span class="keyword">case</span> <span class="string">"twitter"</span>:
        <span class="keyword">case</span> <span class="string">"facebook"</span>:
        <span class="keyword">case</span> <span class="string">"password"</span>:
          <span class="keyword">if</span> (!<span class="keyword">this</span>._authClient) {
            <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">"Simple Login not initialized"</span>);
            $rootScope.$broadcast(<span class="string">"angularFireAuth:error"</span>, err);
          } <span class="keyword">else</span> {
            <span class="keyword">this</span>._authClient.login(tokenOrProvider, options);
          }
          <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>A token was provided, so initialize custom login.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">default</span>:
          <span class="keyword">var</span> claims, self = <span class="keyword">this</span>;
          <span class="keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Extract claims and update user auth state to include them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            claims = deconstructJWT(tokenOrProvider);
            <span class="keyword">this</span>._ref.auth(tokenOrProvider, <span class="keyword">function</span>(err) {
              <span class="keyword">if</span> (err) {
                $rootScope.$broadcast(<span class="string">"angularFireAuth:error"</span>, err);
              } <span class="keyword">else</span> {
                self._loggedIn(claims);
              }
            });
          } <span class="keyword">catch</span>(e) {
            $rootScope.$broadcast(<span class="string">"angularFireAuth:error"</span>, e)
          }
        }
        <span class="keyword">return</span> promise;
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Function cb receives an error as the first argument and a
Simple Login user object as the second argument. Pass noLogin=true
if you don&#39;t want the newly created user to also be logged in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      createUser: <span class="keyword">function</span>(email, password, cb, noLogin){
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">this</span>._authClient.createUser(email, password, <span class="keyword">function</span>(err, user){
          <span class="keyword">try</span> {
            <span class="keyword">if</span> (err) {
              $rootScope.$broadcast(<span class="string">"angularFireAuth:error"</span>, err);
            } <span class="keyword">else</span> {
              <span class="keyword">if</span> (!noLogin) {
                self.login(<span class="string">"password"</span>, {email: email, password: password});
              }
            }
          } <span class="keyword">catch</span>(e) {
            $rootScope.$broadcast(<span class="string">"angularFireAuth:error"</span>, e);
          }
          <span class="keyword">if</span> (cb) {
            $timeout(<span class="keyword">function</span>(){
              cb(err, user);
            });
          }
        });
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Unauthenticate the Firebase reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      logout: <span class="keyword">function</span>() {
        <span class="keyword">if</span> (<span class="keyword">this</span>._authClient) {
          <span class="keyword">this</span>._authClient.logout();
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>._ref.unauth();
          <span class="keyword">this</span>._loggedOut();
        }
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Common function to trigger a login event on the root scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _loggedIn: <span class="keyword">function</span>(user) {
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">this</span>._authenticated = <span class="literal">true</span>;
        updateExpression(<span class="keyword">this</span>._scope, <span class="keyword">this</span>._name, user, <span class="keyword">function</span>() {
          $rootScope.$broadcast(<span class="string">"angularFireAuth:login"</span>, user);
          <span class="keyword">if</span> (self._redirectTo) {
            $location.replace();
            $location.path(self._redirectTo);
            self._redirectTo = <span class="literal">null</span>;
          }
        });
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Common function to trigger a logout event on the root scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _loggedOut: <span class="keyword">function</span>() {
        <span class="keyword">this</span>._authenticated = <span class="literal">false</span>;
        updateExpression(<span class="keyword">this</span>._scope, <span class="keyword">this</span>._name, <span class="literal">null</span>, <span class="keyword">function</span>() {
          $rootScope.$broadcast(<span class="string">"angularFireAuth:logout"</span>);
        });
      },

      _watchForLogin: <span class="keyword">function</span>() {
        <span class="keyword">var</span> subs = [], def = $q.defer();
        <span class="function"><span class="keyword">function</span> <span class="title">done</span><span class="params">(err, user)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>timeout is necessary because it a) allows the auth callbacks to take
effect (applying auth parms before this is invoked) and b) forces
$scope.apply(), which is necessary to make the promise resolve()
event actually get sent to the listeners</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          $timeout(<span class="keyword">function</span>() {
            <span class="keyword">if</span> (err) {
              def.reject(err);
            } <span class="keyword">else</span> {
              def.resolve(user);
            }
          });
          <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; subs.length; i++) {
            subs[i]();
          }
        }
        subs.push($rootScope.$on(<span class="string">"angularFireAuth:login"</span>, <span class="keyword">function</span>(evt, user) {
          done(<span class="literal">null</span>, user);
        }));
        subs.push($rootScope.$on(<span class="string">"angularFireAuth:error"</span>, <span class="keyword">function</span>(evt, err) {
          done(err, <span class="literal">null</span>);
        }));
        <span class="keyword">return</span> def.promise;
      }
    }
  }
]);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
